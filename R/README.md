## **R CODE**

This folder contains the R code to use a spatio-temporal P-spline model to obtain estimates of mortality risks from prostate cancer in 50 Spanish provinces 
in the period 1975-2008. In addition we will obtain the predictions of the risks for future years.

**Step 1: Obtaining risk estimates.**

1.  Open the *Fitting* folder.
2.  Run the **`Step1_CreateBasis.r`** file to get the B-spline bases and the fixed and random effects matrices of the mixed model. These matrices are automatically saved to the *dumpsdata* folder after the entire file is executed.
3.  Open the file **`Step2_FittingTheModel.r`** : In this file the P-splines model is fitted.
    -   Through `source(PQL.r)` the model is fitted (It takes a while to execute).

    -   Confidence intervals are computed when loading `source (msespline.r)`

    -   Trend graphs and maps are generated with `source(plots.r)`. They are automatically saved in pdf with the names Plot_RisksTrends.pdf and Plot_RisksMaps.pdf respectively.

    -   The AIC and BIC values are displayed using the AIC and BIC command.

    -   Finally, with `save.image("ANOVATypePspline_Estimation_Date.RDATA")` we save all the results.

**Step 2: Forecasting risks**

1.  Open the *Forecasting* folder.

2.  Copy the *dumpsdata* folder and its content to the *Forecasting* folder.

3.  Run the code of **`Step1_Forecasting.r`** file. This file generates the B-spline bases and the fixed and random effects matrices of the mixed model [for the extended model]{.underline}. Risk predictions are also calculated. The risk matrix is ​​automatically saved to the *dumpsdataPred* folder after the entire file is executed.

4.  Run the **`Step2_PredictionMSE.r`** file . The syntax of this file allows calculation of prediction intervals for future risks. Finally, the trend plots and maps of the adjusted and predicted risks are generated by running the `Plots.r` file. They are automatically saved in pdf with the names `Plot_RisksTrendsPrediction.pdf` and `Plot_RisksMapsPrediction.pdf` respectively. To plot the various components of the model, run `PlotsComponenetsColor.r` to plot the components for the estimates or `PlotComponentsWithPrediction.r` to plot the components for the estimates and predictions.

``` r
R version 4.2.1 (2022-06-23 ucrt)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 17763)

Matrix products: default

locale:
[1] LC_COLLATE=Spanish_Spain.1252  LC_CTYPE=Spanish_Spain.1252    LC_MONETARY=Spanish_Spain.1252 LC_NUMERIC=C                  
[5] LC_TIME=Spanish_Spain.1252    

attached base packages:
[1] splines   stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] spdep_1.2-5        sf_1.0-8           spData_2.2.0       splancs_2.01-43    RColorBrewer_1.1-3 maptools_1.1-4     sp_1.5-0          
 [8] mvtnorm_1.1-3      MASS_7.3-57        mgcv_1.8-40        nlme_3.1-157      

loaded via a namespace (and not attached):
 [1] xfun_0.32          tidyselect_1.2.0   lattice_0.20-45    vctrs_0.4.2        generics_0.1.3     htmltools_0.5.3    s2_1.1.0          
 [8] yaml_2.3.5         utf8_1.2.2         rlang_1.0.6        e1071_1.7-11       pillar_1.8.1       foreign_0.8-82     glue_1.6.2        
[15] DBI_1.1.3          wk_0.6.0           lifecycle_1.0.3    evaluate_0.17      knitr_1.40         fastmap_1.1.0      class_7.3-20      
[22] fansi_1.0.3        Rcpp_1.0.9         KernSmooth_2.23-20 classInt_0.4-7     deldir_1.0-6       digest_0.6.29      dplyr_1.0.10      
[29] grid_4.2.1         rgdal_1.5-32       cli_3.3.0          tools_4.2.1        magrittr_2.0.3     proxy_0.4-27       tibble_3.1.8      
[36] pkgconfig_2.0.3    Matrix_1.4-1       assertthat_0.2.1   rmarkdown_2.16     rstudioapi_0.14    R6_2.5.1           boot_1.3-28       
[43] units_0.8-0        compiler_4.2.1  
```

