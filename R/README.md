## **R CODE**

This folder contains the R code to use a spatio-temporal P-spline model to obtain estimates of mortality risks from prostate cancer in 50 Spanish provinces 
in the period 1975-2008. In addition we will obtain the predictions of the risks for future years.

**Step 1: Obtaining risk estimates.**

1.  Open the *Fitting* folder.
2.  Run the **`Step1_CreateBasis.r`** file to get the B-spline bases and the fixed and random effects matrices of the mixed model. These matrices are automatically saved to the *dumpsdata* folder after the entire file is executed.
3.  Open the file **`Step2_FittingTheModel.r`** : In this file the P-splines model is fitted.
    -   Through `source(PQL.r)` the model is fitted (It takes a while to execute).

    -   Confidence intervals are computed when loading `source (msespline.r)`

    -   Trend graphs and maps are generated with `source(plots.r)`. They are automatically saved in pdf with the names Plot_RisksTrends.pdf and Plot_RisksMaps.pdf respectively.

    -   The AIC and BIC values are displayed using the AIC and BIC command.

    -   Finally, with `save.image("ANOVATypePspline_Estimation_Date.RDATA")` we save all the results.

**Step 2: Forecasting risks**

1.  Open the *Forecasting* folder.

2.  Copy the *dumpsdata* folder and its content to the *Forecasting* folder.

3.  Run the code of **`Step1_Forecasting.r`** file. This file generates the B-spline bases and the fixed and random effects matrices of the mixed model [for the extended model]{.underline}. Risk predictions are also calculated. The risk matrix is ​​automatically saved to the *dumpsdataPred* folder after the entire file is executed.

4.  Run the **`Step2_PredictionMSE.r`** file . The syntax of this file allows calculation of prediction intervals for future risks. Finally, the trend plots and maps of the adjusted and predicted risks are generated by running the `Plots.r` file. They are automatically saved in pdf with the names `Plot_RisksTrendsPrediction.pdf` and `Plot_RisksMapsPrediction.pdf` respectively. To plot the various components of the model, run `PlotsComponenetsColor.r` to plot the components for the estimates or `PlotComponentsWithPrediction.r` to plot the components for the estimates and predictions.


